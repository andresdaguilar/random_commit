name: Random Commit Bot 2

on:
  schedule:
    # Trigger commits every 90 minutes
    - cron: '0 */3 * * *'       # Every 3 hours (00:00, 03:00, 06:00, ...)
    - cron: '30 1-23/3 * * *'   # 90 minutes after the start of each 3-hour block (01:30, 04:30, ...)
    # Trigger pull request creation and merge every 8 hours
    - cron: '0 */8 * * *'       # Every 8 hours
  workflow_dispatch:  # Allow manual execution

jobs:
  random-commit:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # Step 3: Run the Python script
      - name: Run Random Commit Script
        run: |
          python random_commit.py

      # Step 4: Push Changes to the dev Branch
      - name: Push Changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            git config --global user.name "GitHub Actions Bot"
            git config --global user.email "action@github.com"
            git remote set-url origin https://x-access-token:${TOKEN}@github.com/andresdaguilar/random_commit.git
            git checkout -B dev
            git stash  # Stash local changes
            git pull origin dev --rebase || {  # Pull the latest changes and rebase
              echo "Conflict detected. Resolving automatically.";
              git rebase --abort;  # Abort the rebase
              git pull origin dev --strategy-option theirs;  # Resolve using "theirs" strategy
            }
            git stash pop || echo "No stashed changes to apply"  # Reapply stashed changes if any
            git add .
            git commit -m "Automated random commit" || echo "No changes to commit"
            git push origin dev

  create-pull-request:
    needs: random-commit  # Ensure commits are made before creating a PR
    runs-on: ubuntu-latest
    if: github.event.schedule # Ensures this job only runs on a schedule
    steps:
      # Step 1: Check out the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Create Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          head: dev
          title: "Automated Pull Request from dev to main"
          body: "This pull request merges the latest changes from the dev branch into main."
          branch: auto-pr/dev-to-main

      # Step 3: Merge Pull Request
      - name: Merge Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --state=open --base=main --head=auto-pr/dev-to-main --json number -q '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr merge $PR_NUMBER --merge --delete-branch --admin
          fi
